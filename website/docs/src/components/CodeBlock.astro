---
const { code = "", lang = "bash" } = Astro.props;
const uid = `code-${Math.random().toString(36).slice(2, 9)}`;
---

<div class="codeblock" data-uid={uid}>
  <pre><code id={uid}>{code}</code></pre>
  <button id={uid + "-btn"} class="copy" aria-label="Copy">Copy</button>
</div>

<script>
  function setupCopyButtons() {
    const blocks = document.querySelectorAll(".codeblock");
    blocks.forEach((block) => {
      if (block.hasAttribute("data-initialized")) return;
      block.setAttribute("data-initialized", "true");

      const uid = block.getAttribute("data-uid");
      const btn = document.getElementById(uid + "-btn");
      const el = document.getElementById(uid);

      if (!btn || !el) return;

      btn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(el.innerText);
          const prev = btn.textContent;
          btn.textContent = "Copied!";
          setTimeout(() => (btn.textContent = prev), 1200);
        } catch (e) {
          console.error("copy failed", e);
        }
      });
    });
  }

  // Setup on load and after swaps (for Starlight/SPAs)
  setupCopyButtons();
  document.addEventListener("astro:after-swap", setupCopyButtons);
</script>

<style>
  .codeblock {
    position: relative;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 10px;
    padding: 16px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;
    color: #d6eefa;
  }
  .codeblock pre {
    margin: 0;
    overflow: auto;
    max-height: 220px;
  }
  .copy {
    position: absolute;
    right: 10px;
    top: 10px;
    background: rgba(255, 255, 255, 0.04);
    border: none;
    padding: 6px 8px;
    border-radius: 6px;
    color: inherit;
    cursor: pointer;
  }
</style>
