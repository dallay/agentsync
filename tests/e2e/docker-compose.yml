services:
  # 1. Mock Skill Provider (Nginx)
  mock-provider:
    image: nginx:alpine
    volumes:
      - ./fixtures:/usr/share/nginx/html:ro
    ports:
      - "8080:80"

  # 2. Test Runner (Ubuntu)
  test-runner-ubuntu:
    build:
      context: ../..
      dockerfile: tests/e2e/Dockerfile.e2e
      args:
        BASE_IMAGE: ${UBUNTU_IMAGE:-ubuntu@sha256:cd1dba651b3080c3686ecf4e3c4220f026b521fb76978881737d24f200828b2b}
    depends_on:
      - mock-provider
    volumes:
      - ./test_suite.sh:/test_suite.sh:ro
    environment:
      - PROVIDER_URL=http://mock-provider
    command: /test_suite.sh

  # 3. Test Runner (Alpine)
  test-runner-alpine:
    # Use a build block to ensure agentsync is installed
    build:
      context: ../..
      dockerfile: tests/e2e/Dockerfile.e2e
      args:
        BASE_IMAGE: ${ALPINE_IMAGE:-alpine@sha256:6baf43584bcb78f2e5847d1de515f23499913ac9f12bdf834811a3145eb11ca1}
        BUILD_TYPE: musl
    depends_on:
      - mock-provider
    volumes:
      - ./test_suite.sh:/test_suite.sh:ro
    environment:
      - PROVIDER_URL=http://mock-provider
    command: /test_suite.sh

  # 4. Test Runner (Arch)
  test-runner-arch:
    platform: linux/amd64
    build:
      context: ../..
      dockerfile: tests/e2e/Dockerfile.e2e
      args:
        BASE_IMAGE: ${ARCH_IMAGE:-archlinux@sha256:9b8e02df0f0a08fa8144d901932bd85d751257f83e00314053314a27ff87884f}
    depends_on:
      - mock-provider
    volumes:
      - ./test_suite.sh:/test_suite.sh:ro
    environment:
      - PROVIDER_URL=http://mock-provider
    command: /test_suite.sh
