name: Issue Labeler

on:
  issues:
    types: [opened, edited]

jobs:
  label:
    name: Auto-label issues
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Label issue based on content
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            const escapeRegex = (string) => {
              return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            };

            const issue = context.payload.issue;
            const title = issue.title;
            const body = issue.body || "";
            const labelsToAdd = [];

            const mappings = {
              'backend': ['backend', 'rust', 'cli'],
              'ci': ['ci', 'workflow', 'github action', 'github actions'],
              'chore': ['chore', 'maintenance'],
              'dependencies': ['dependencies']
            };

            for (const [label, keywords] of Object.entries(mappings)) {
              if (keywords.some(keyword => {
                const regex = new RegExp(`\\b${escapeRegex(keyword)}\\b`, 'i');
                return regex.test(title) || regex.test(body);
              })) {
                labelsToAdd.push(label);
              }
            }

            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labelsToAdd
              });
            }
